<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>EAN-13 Generator (Single + Bulk)</title>
    <script src="https://unpkg.com/jsbarcode@latest/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Font to outlines helper -->
    <script src="https://cdn.jsdelivr.net/npm/opentype.js@1.3.4/dist/opentype.min.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: "PPNeueMontreal-Medium";
            padding: 24px;
            max-width: 900px;
            margin: 0 auto;
            min-height: 100dvh;
            box-sizing: border-box;
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        input[type="text"],
        textarea {
            padding: 6px 10px;
            font-size: 14px;
            font-family: inherit;
        }

        input[type="text"] {
            width: 180px;
        }

        textarea {
            width: 100%;
            box-sizing: border-box;
            resize: none;
            height: 200px;
        }

        button {
            padding: 6px 12px;
            font-size: 14px;
            cursor: pointer;
            border: solid 2px black;
            background-color: black;
            color: white;
            border-radius: 3px;
            transition: all .7s ease;
        }

        button:hover {
            background-color: #D593F6;
            border-color: #D593F6;
            transition: all .1s ease;
        }

        #error,
        #bulkError {
            color: #c00;
            font-size: 12px;
            margin-top: 4px;
            white-space: pre-line;
        }

        h2 {
            margin-top: 32px;
            margin-bottom: 8px;
            font-size: 48px;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <!-- Single code section -->
    <h2>Один EAN-13</h2>
    <div class="controls">
        <label>
            <input id="codeInput" type="text" value="4816196900019" maxlength="13" />
        </label>
        <button id="generateBtn">Сгенерироватть</button>
        <button id="downloadBtn">Скачать</button>
    </div>
    <div id="error"></div>
    <svg id="barcode"></svg>

    <!-- Bulk section -->
    <h2>Несколько EAN-13 (один на строчку)</h2>
    <textarea id="bulkInput" placeholder="481619690001
590123412345
400638133393"></textarea>
    <div class="controls">
        <button id="bulkDownloadBtn">Сгенерировать и скачать архив</button>
    </div>
    <div id="bulkError"></div>

    <script>
        // ------------ TEXT → OUTLINES HELPERS (no style changes) ------------

        // 1) Point this to your Inter font file (same one you use in the browser)
        const INTER_FONT_URL = './PPNeueMontreal-Medium.ttf'; // <- put your real URL here

        let interFontPromise = null;

        function loadInterFont() {
            if (!interFontPromise) {
                interFontPromise = new Promise((resolve, reject) => {
                    if (!window.opentype) {
                        reject(new Error('opentype.js not loaded'));
                        return;
                    }
                    opentype.load(INTER_FONT_URL, function (err, font) {
                        if (err) {
                            console.error('Error loading Inter font for outlining:', err);
                            reject(err);
                        } else {
                            resolve(font);
                        }
                    });
                });
            }
            return interFontPromise;
        }

        function getFontSizeFromText(textEl) {
            const direct = textEl.getAttribute('font-size');
            if (direct) return parseFloat(direct);

            const style = textEl.getAttribute('style') || '';
            const match = style.match(/font-size:\s*([\d.]+)px/);
            if (match) return parseFloat(match[1]);

            return 16; // fallback, but JsBarcode sets it explicitly anyway
        }

        function getFillFromText(textEl) {
            const direct = textEl.getAttribute('fill');
            if (direct && direct !== 'none') return direct;

            const style = textEl.getAttribute('style') || '';
            const match = style.match(/fill:\s*([^;]+)/);
            if (match) return match[1].trim();

            return '#000000'; // default barcode text color
        }

        async function outlineTextInSvg(svgElement) {
            const font = await loadInterFont();
            const textNodes = Array.from(svgElement.querySelectorAll('text'));

            textNodes.forEach(textEl => {
                const text = textEl.textContent;
                if (!text || !text.trim()) return;

                const fontSize = getFontSizeFromText(textEl);
                const fill = getFillFromText(textEl);

                const xAttr = textEl.getAttribute('x');
                const yAttr = textEl.getAttribute('y');
                let x = xAttr ? parseFloat(xAttr) : 0;
                const y = yAttr ? parseFloat(yAttr) : 0;

                // Respect text-anchor so outlined text stays centered/aligned
                const anchor = textEl.getAttribute('text-anchor') || 'start';
                if (anchor !== 'start') {
                    const advanceWidth = font.getAdvanceWidth(text, fontSize);
                    if (anchor === 'middle') {
                        x -= advanceWidth / 2;
                    } else if (anchor === 'end') {
                        x -= advanceWidth;
                    }
                }

                // Create a single path for the full string
                const path = font.getPath(text, x, y, fontSize);

                let d;
                if (typeof path.toPathData === 'function') {
                    d = path.toPathData(2);
                } else if (typeof path.toSVG === 'function') {
                    const svgString = path.toSVG();
                    const m = svgString.match(/d="([^"]+)"/);
                    d = m ? m[1] : '';
                } else {
                    console.warn('No toPathData/toSVG on opentype path; skipping outlining for this text.');
                    return;
                }

                if (!d) return;

                const pathEl = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                pathEl.setAttribute('d', d);
                pathEl.setAttribute('fill', fill);

                const transform = textEl.getAttribute('transform');
                if (transform) {
                    pathEl.setAttribute('transform', transform);
                }

                // Replace text with path, keeping everything else intact
                textEl.parentNode.replaceChild(pathEl, textEl);
            });
        }

        // ------------ ORIGINAL LOGIC (only export paths changed) ------------

        function generateBarcode(code) {
            const errorEl = document.getElementById("error");
            errorEl.textContent = "";

            // Only digits, length 12 or 13
            if (!/^\d{12,13}$/.test(code)) {
                errorEl.textContent = "Code must be 12 or 13 digits (numbers only).";
                return;
            }

            JsBarcode("#barcode", code, {
                format: "ean13",
                lineColor: "#000000",
                background: "#ffffff",
                width: 2,
                height: 20,
                font: "PPNeueMontreal-Medium", // only works if font is loaded
                fontSize: 18,
                margin: 0,
                flat: true,
                textMargin: 0,
            });
        }

        async function downloadSVG() {
            const svg = document.getElementById("barcode");
            const code = document.getElementById("codeInput").value.trim();

            if (!svg || !svg.innerHTML.trim()) {
                alert("Generate a barcode first.");
                return;
            }

            // Work on a clone so on-screen preview stays text-based
            const svgClone = svg.cloneNode(true);
            try {
                await outlineTextInSvg(svgClone);
            } catch (e) {
                console.warn('Could not outline text, exporting as-is:', e);
            }

            const serializer = new XMLSerializer();
            let source = serializer.serializeToString(svgClone);

            if (!source.match(/^<\?xml/)) {
                source = '<?xml version="1.0" encoding="UTF-8"?>\n' + source;
            }

            const blob = new Blob([source], {
                type: "image/svg+xml;charset=utf-8",
            });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = `ean13-${code || "barcode"}.svg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function bulkDownload() {
            const bulkErrorEl = document.getElementById("bulkError");
            bulkErrorEl.textContent = "";

            const raw = document.getElementById("bulkInput").value;
            const lines = raw
                .split("\n")
                .map((l) => l.trim())
                .filter((l) => l.length > 0);

            if (lines.length === 0) {
                bulkErrorEl.textContent = "Add at least one code (one per line).";
                return;
            }

            const zip = new JSZip();
            const invalid = [];

            for (const line of lines) {
                const code = line;

                if (!/^\d{12,13}$/.test(code)) {
                    invalid.push(code);
                    continue;
                }

                // Create an in-memory SVG element
                const svg = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "svg"
                );

                JsBarcode(svg, code, {
                    format: "ean13",
                    lineColor: "#000000",
                    background: "#ffffff",
                    width: 2,
                    height: 20,
                    font: "PPNeueMontreal-Medium",
                    fontSize: 18,
                    margin: 0,
                    flat: true,
                    textMargin: 0,
                });

                try {
                    await outlineTextInSvg(svg);
                } catch (e) {
                    console.warn('Could not outline text for code', code, e);
                    // If outlining fails, we still export the text-based SVG
                }

                const serializer = new XMLSerializer();
                let source = serializer.serializeToString(svg);

                if (!source.match(/^<\?xml/)) {
                    source = '<?xml version="1.0" encoding="UTF-8"?>\n' + source;
                }

                zip.file(`ean13-${code}.svg`, source);
            }

            if (invalid.length === lines.length) {
                bulkErrorEl.textContent =
                    "All lines were invalid. Use 12 or 13 digits per line.";
                return;
            }

            if (invalid.length > 0) {
                bulkErrorEl.textContent =
                    "Some codes were skipped (invalid format):\n" + invalid.join("\n");
            }

            const blob = await zip.generateAsync({ type: "blob" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = "ean13-barcodes.zip";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Wire up UI
        document.getElementById("generateBtn").addEventListener("click", () => {
            const code = document.getElementById("codeInput").value.trim();
            generateBarcode(code);
        });

        document
            .getElementById("downloadBtn")
            .addEventListener("click", downloadSVG);
        document
            .getElementById("bulkDownloadBtn")
            .addEventListener("click", bulkDownload);

        // Generate once on load with default
        generateBarcode(document.getElementById("codeInput").value.trim());
    </script>
</body>

</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>EAN-13 Generator (Single + Bulk)</title>
    <script src="https://unpkg.com/jsbarcode@latest/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Font to outlines helper -->
    <script src="https://cdn.jsdelivr.net/npm/opentype.js@1.3.4/dist/opentype.min.js"></script>

    <!-- Export libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
      * {
        box-sizing: border-box;
      }

      @font-face {
        font-family: "GaramondNarrowLightITC";
        src: url("./GaramondNarrowLightITC.woff2") format("woff2");
        font-weight: 500;
        font-style: normal;
        font-display: swap;
      }

      @font-face {
        font-family: "PP Neue Montreal";
        src: url("./PPNeueMontreal-Medium.woff2") format("woff2");
        font-weight: 500;
        font-style: normal;
        font-display: swap;
      }

      body {
        font-family: "PP Neue Montreal";
        padding: 24px;
        max-width: 900px;
        margin: 0 auto;
        min-height: 100dvh;
        background-color: #f2f2f2;
        box-sizing: border-box;
      }

      .barcode {
        inset: 10px;
        padding: 1px;
      }

      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }

      input[type="text"],
      textarea {
        padding: 6px 10px;
        font-size: 14px;
        font-family: inherit;
      }

      input[type="text"] {
        width: 180px;
      }

      textarea {
        width: 100%;
        box-sizing: border-box;
        resize: none;
        height: 200px;
      }

      button {
        padding: 6px 12px;
        font-size: 14px;
        cursor: pointer;
        border: solid 2px black;
        background-color: black;
        color: white;
        border-radius: 3px;
        transition: all 0.7s ease;
      }

      button:hover {
        background-color: #d593f6;
        border-color: #d593f6;
        transition: all 0.1s ease;
      }

      #error,
      #bulkError {
        color: #c00;
        font-size: 12px;
        margin-top: 4px;
        white-space: pre-line;
      }

      h2 {
        margin-top: 32px;
        margin-bottom: 8px;
        font-size: 48px;
        font-weight: 500;
      }

      .label-controls {
        flex-direction: column;
        align-items: flex-start;
      }

      .label-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        width: 100%;
      }

      .label-row input {
        flex: 1;
      }

      .label {
        width: 570px;
        height: 710px;
        background-color: white;
      }

      p {
        text-transform: uppercase;
        text-align: center;
        margin: 0;
        font-family: "PP Neue Montreal";
      }

      .label {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 10px;
        outline: #d593f6;
      }

      .typography {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 32px;
        height: inherit;
      }

      .coffee-class {
        font-size: 32px;
        padding: 12px 18px;
        border: 3px solid black;
        border-radius: 48px;
        display: inline-flex;
        width: fit-content;
      }

      p.coffee-region {
        font-family: "GaramondNarrowLightITC";
        font-size: 107px;
        line-height: 90%;
        letter-spacing: -0.03em;
      }

      .coffee-descriptors {
        font-size: 32px;
        line-height: 108%;
      }

      .coffee-method {
        font-size: 22px;
        line-height: 108%;
        max-width: 30%;
      }

      @media print {
        body {
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
          background-color: #fff5ff !important;
        }
      }

      /* ---------- MOCKUP SECTION ---------- */

      .mockup-wrap {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
        margin-top: 12px;
      }

      .mockup-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      .mockup-controls .group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      .mockup-controls label {
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .mockup-controls select,
      .mockup-controls input[type="color"],
      .mockup-controls input[type="file"] {
        font-family: inherit;
        font-size: 13px;
      }

      .mockup-stage {
        width: 100%;
        max-width: 900px;
        margin: 0;
        border: 2px solid #000;
        background: #fff;
        position: relative;
        overflow: hidden;

        aspect-ratio: 4 / 5;

        display: grid;
        place-items: center;
      }

      .mockup-stage.is-transparent {
        background: transparent;
        background-image: linear-gradient(
            45deg,
            rgba(0, 0, 0, 0.08) 25%,
            transparent 25%
          ),
          linear-gradient(-45deg, rgba(0, 0, 0, 0.08) 25%, transparent 25%),
          linear-gradient(45deg, transparent 75%, rgba(0, 0, 0, 0.08) 75%),
          linear-gradient(-45deg, transparent 75%, rgba(0, 0, 0, 0.08) 75%);
        background-size: 28px 28px;
        background-position: 0 0, 0 14px, 14px -14px, -14px 0px;
      }

      .mockup-layer {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        pointer-events: none;
        perspective: 10200px;
        align-content: center;
        align-items: center;
        justify-content: center;
      }

      .mockup-image {
        width: 1024px;
        height: 1280px;
        object-fit: contain;
        display: none;
        transform: scale(0.8);
      }

      /* Stable base + independent X/Y scale */
      .mockup-label {
        width: 570px;
        height: 710px;
        aspect-ratio: 570 / 710;
        display: grid;
        justify-content: center;
        place-items: center;
        transform: translateY(-66px) translateX(-3px) scale(0.28, 0.3)
          rotateX(34deg) rotateZ(-0.45deg);
        opacity: 0.7;
        background: none !important;
      }

      .mockup-label .label {
        transform-origin: center;
        background: none !important;
      }

      .mockup-label .label .barcode {
        background-color: transparent !important;
      }

      .mockup-swatch {
        width: 24px;
        height: 24px;
        border: 2px solid #000;
        border-radius: 6px;
        padding: 0;
        background: transparent;
        cursor: pointer;
      }

      .mockup-swatch.is-active {
        outline: 2px solid #d593f6;
        outline-offset: 2px;
      }
    </style>
  </head>

  <body>
    <h2>Штрих-код EAN-13</h2>
    <div class="controls">
      <label>
        <input id="codeInput" type="text" value="4816196900019" maxlength="13" />
      </label>
      <button id="generateBtn">Сгенерироватть</button>
      <button id="downloadBtn">Скачать</button>
    </div>
    <div id="error"></div>
    <svg id="barcodePreview"></svg>

    <h2>Текст для этикетки</h2>
    <div class="controls label-controls">
      <div class="label-row">
        <input id="labelClassInput" type="text" value="Эспрессо" placeholder="Класс кофе" />
        <input id="labelRegionInput" type="text" value="Эфиопия сидамо" placeholder="Регион" />
      </div>
      <div class="label-row">
        <input
          id="labelDescriptorsInput"
          type="text"
          value="Абрикос, бергамот, цитрусовый микс"
          placeholder="Дескрипторы"
        />
        <input id="labelMethodInput" type="text" value="Мытая обработка" placeholder="Метод обработки" />
      </div>

      <label style="display: flex; align-items: center; gap: 6px; margin-top: 4px; margin-bottom: 12px">
        <input type="checkbox" id="toggleLabelBarcode" checked />
        Показывать штрих-код на этикетке
      </label>

      <button style="display: none" id="downloadLabelBtn">Скачать этикетку (SVG)</button>
      <button id="downloadLabelPdfBtn">Скачать этикетку (PDF)</button>
    </div>

    <div class="label" id="coffeeLabel">
      <div class="typography">
        <p class="coffee-class" id="labelCoffeeClass">Эспрессо</p>
        <p class="coffee-region" id="labelCoffeeRegion">Эфиопия сидамо</p>
        <p class="coffee-descriptors" id="labelCoffeeDescriptors">Абрикос, бергамот, цитрусовый микс</p>
        <p class="coffee-method" id="labelCoffeeMethod">мытая обработка</p>
      </div>
      <div class="barcode">
        <svg id="labelBarcode"></svg>
      </div>
    </div>

    <h2>Mockup (фон + изображение + копия этикетки)</h2>

    <div class="mockup-wrap">
      <div class="controls mockup-controls">
        <div class="group">
          <label style="user-select: none">
            <input type="checkbox" id="mockupTransparent" />
            Transparent BG
          </label>
        </div>

        <div class="group">
          <label>
            Image
            <input type="file" id="mockupImage" accept="image/*" />
          </label>

          <button id="mockupClearImage" type="button">Убрать изображение</button>
          <button id="mockupRefreshLabel" type="button">Обновить копию этикетки</button>
        </div>

        <div class="group">
          <span style="font-size: 12px">BG presets</span>
          <button class="mockup-swatch" id="bg1" type="button" title="BG 1"></button>
          <button class="mockup-swatch" id="bg2" type="button" title="BG 2"></button>
          <button class="mockup-swatch" id="bg3" type="button" title="BG 3"></button>
          <button class="mockup-swatch" id="bg4" type="button" title="BG 4"></button>

          <label>
            Custom
            <input type="color" id="mockupBgCustom" value="#ffffff" />
          </label>

          <button id="mockupDownloadImg" type="button">Скачать изображение (PNG)</button>
        </div>
      </div>

      <div id="mockupStage" class="mockup-stage" aria-label="Mockup stage">
        <div class="mockup-layer">
          <img id="mockupImgEl" class="mockup-image" alt="" />
        </div>

        <div class="mockup-layer">
          <div id="mockupLabelHolder" class="mockup-label"></div>
        </div>
      </div>
    </div>

    <h2>Несколько EAN-13 (один на строчку)</h2>
    <textarea id="bulkInput" placeholder="481619690001&#10;590123412345&#10;400638133393"></textarea>
    <div class="controls">
      <button id="bulkDownloadBtn">Сгенерировать и скачать архив</button>
    </div>
    <div id="bulkError"></div>

    <script>
      function openPrintLabelWindow() {
        const label = document.getElementById("coffeeLabel");
        if (!label) {
          alert("Label not found.");
          return;
        }

        const printWindow = window.open("", "_blank", "width=570,height=710");
        if (!printWindow) {
          alert("Please allow popups to print the label.");
          return;
        }

        const styles = Array.from(document.querySelectorAll("head style"))
          .map((style) => style.textContent || "")
          .join("\n");

        const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Coffee Label</title>
  <style>
    ${styles}
    body {
      margin: 0;
      padding: 0;
      background: gray;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    @page {
      margin: 0;
      padding: 0;
      background: gray;
      height: 710px;
      width: 570px;
    }
  </style>
</head>
<body>
  ${label.outerHTML}
  <script>
    window.onload = function () {
      window.focus();
      window.print();
    };
  <\/script>
</body>
</html>`;

        printWindow.document.open();
        printWindow.document.write(html);
        printWindow.document.close();
      }

      // ------------ TEXT → OUTLINES HELPERS (no style changes) ------------

      const INTER_FONT_URL = "./PPNeueMontreal-Medium.woff2";
      let interFontPromise = null;

      function loadInterFont() {
        if (!interFontPromise) {
          interFontPromise = new Promise((resolve, reject) => {
            if (!window.opentype) {
              reject(new Error("opentype.js not loaded"));
              return;
            }
            opentype.load(INTER_FONT_URL, function (err, font) {
              if (err) {
                console.error("Error loading Inter font for outlining:", err);
                reject(err);
              } else {
                resolve(font);
              }
            });
          });
        }
        return interFontPromise;
      }

      function getFontSizeFromText(textEl) {
        const direct = textEl.getAttribute("font-size");
        if (direct) return parseFloat(direct);

        const style = textEl.getAttribute("style") || "";
        const match = style.match(/font-size:\s*([\d.]+)px/);
        if (match) return parseFloat(match[1]);

        return 16;
      }

      function getFillFromText(textEl) {
        const direct = textEl.getAttribute("fill");
        if (direct && direct !== "none") return direct;

        const style = textEl.getAttribute("style") || "";
        const match = style.match(/fill:\s*([^;]+)/);
        if (match) return match[1].trim();

        return "#000000";
      }

      async function outlineTextInSvg(svgElement) {
        const font = await loadInterFont();
        const textNodes = Array.from(svgElement.querySelectorAll("text"));

        textNodes.forEach((textEl) => {
          const text = textEl.textContent;
          if (!text || !text.trim()) return;

          const fontSize = getFontSizeFromText(textEl);
          const fill = getFillFromText(textEl);

          const xAttr = textEl.getAttribute("x");
          const yAttr = textEl.getAttribute("y");
          let x = xAttr ? parseFloat(xAttr) : 0;
          const y = yAttr ? parseFloat(yAttr) : 0;

          const anchor = textEl.getAttribute("text-anchor") || "start";
          if (anchor !== "start") {
            const advanceWidth = font.getAdvanceWidth(text, fontSize);
            if (anchor === "middle") x -= advanceWidth / 2;
            else if (anchor === "end") x -= advanceWidth;
          }

          const path = font.getPath(text, x, y, fontSize);

          let d;
          if (typeof path.toPathData === "function") d = path.toPathData(2);
          else if (typeof path.toSVG === "function") {
            const svgString = path.toSVG();
            const m = svgString.match(/d="([^"]+)"/);
            d = m ? m[1] : "";
          } else {
            console.warn("No toPathData/toSVG; skipping outlining.");
            return;
          }

          if (!d) return;

          const pathEl = document.createElementNS("http://www.w3.org/2000/svg", "path");
          pathEl.setAttribute("d", d);
          pathEl.setAttribute("fill", fill);

          const transform = textEl.getAttribute("transform");
          if (transform) pathEl.setAttribute("transform", transform);

          textEl.parentNode.replaceChild(pathEl, textEl);
        });
      }

      const baseBarcodeOptions = {
        format: "ean13",
        lineColor: "#000000",
        background: "none",
        width: 2,
        height: 20,
        font: "PP Neue Montreal",
        fontSize: 18,
        flat: true,
        textMargin: 0,
      };

      function generateBarcode(code) {
        const errorEl = document.getElementById("error");
        errorEl.textContent = "";

        if (!/^\d{12,13}$/.test(code)) {
          errorEl.textContent = "Code must be 12 or 13 digits (numbers only).";
          return;
        }

        const preview = document.getElementById("barcodePreview");
        if (preview) JsBarcode(preview, code, { ...baseBarcodeOptions, margin: 10 });

        const labelSvg = document.getElementById("labelBarcode");
        if (labelSvg) JsBarcode(labelSvg, code, { ...baseBarcodeOptions, margin: 0 });
      }

      async function downloadSVG() {
        const svg = document.getElementById("barcodePreview");
        const code = document.getElementById("codeInput").value.trim();

        if (!svg || !svg.innerHTML.trim()) {
          alert("Generate a barcode first.");
          return;
        }

        const svgClone = svg.cloneNode(true);
        try {
          await outlineTextInSvg(svgClone);
        } catch (e) {
          console.warn("Could not outline text:", e);
        }

        const serializer = new XMLSerializer();
        let source = serializer.serializeToString(svgClone);
        if (!source.match(/^<\?xml/)) source = '<?xml version="1.0" encoding="UTF-8"?>\n' + source;

        const blob = new Blob([source], { type: "image/svg+xml;charset=utf-8" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `ean13-${code || "barcode"}.svg`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      async function downloadLabelSvg() {
        const label = document.getElementById("coffeeLabel");
        if (!label) {
          alert("Label not found.");
          return;
        }

        const labelClone = label.cloneNode(true);
        const barcodeClone = labelClone.querySelector("svg");
        if (barcodeClone) {
          try {
            await outlineTextInSvg(barcodeClone);
          } catch (e) {
            console.warn("Could not outline barcode text:", e);
          }
        }

        labelClone.setAttribute("xmlns", "http://www.w3.org/1999/xhtml");

        const serializer = new XMLSerializer();
        const serializedLabel = serializer.serializeToString(labelClone);
        const width = label.offsetWidth;
        const height = label.offsetHeight;

        const styles = Array.from(document.querySelectorAll("head style"))
          .map((style) => style.textContent || "")
          .join("\n");

        const svg = `
<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}">
<style><![CDATA[${styles}]]></style>
<foreignObject width="100%" height="100%">
${serializedLabel}
</foreignObject>
</svg>`;

        const blob = new Blob([svg], { type: "image/svg+xml;charset=utf-8" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "coffee-label.svg";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      async function bulkDownload() {
        const bulkErrorEl = document.getElementById("bulkError");
        bulkErrorEl.textContent = "";

        const raw = document.getElementById("bulkInput").value;
        const lines = raw
          .split("\n")
          .map((l) => l.trim())
          .filter((l) => l.length > 0);

        if (lines.length === 0) {
          bulkErrorEl.textContent = "Add at least one code (one per line).";
          return;
        }

        const zip = new JSZip();
        const invalid = [];

        for (const line of lines) {
          const code = line;

          if (!/^\d{12,13}$/.test(code)) {
            invalid.push(code);
            continue;
          }

          const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");

          JsBarcode(svg, code, {
            format: "ean13",
            lineColor: "#000000",
            background: "#ffffff",
            width: 2,
            height: 20,
            font: "PP Neue Montreal",
            fontSize: 18,
            margin: 0,
            flat: true,
            textMargin: 0,
          });

          try {
            await outlineTextInSvg(svg);
          } catch (e) {
            console.warn("Could not outline text for code", code, e);
          }

          const serializer = new XMLSerializer();
          let source = serializer.serializeToString(svg);
          if (!source.match(/^<\?xml/)) source = '<?xml version="1.0" encoding="UTF-8"?>\n' + source;

          zip.file(`ean13-${code}.svg`, source);
        }

        if (invalid.length === lines.length) {
          bulkErrorEl.textContent = "All lines were invalid. Use 12 or 13 digits per line.";
          return;
        }

        if (invalid.length > 0) {
          bulkErrorEl.textContent = "Some codes were skipped:\n" + invalid.join("\n");
        }

        const blob = await zip.generateAsync({ type: "blob" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "ean13-barcodes.zip";
        document.body.appendChild(a);
        a.click();

        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      document.getElementById("generateBtn").addEventListener("click", () => {
        const code = document.getElementById("codeInput").value.trim();
        generateBarcode(code);
      });

      document.getElementById("downloadBtn").addEventListener("click", downloadSVG);
      document.getElementById("bulkDownloadBtn").addEventListener("click", bulkDownload);
      document.getElementById("downloadLabelBtn").addEventListener("click", downloadLabelSvg);

      function fitRegionText() {
        const el = document.getElementById("labelCoffeeRegion");
        if (!el) return;

        const MAX_HEIGHT = 320;
        const BASE_SIZE = 107;
        const MIN_SIZE = 40;

        el.style.fontSize = BASE_SIZE + "px";
        if (el.offsetHeight <= MAX_HEIGHT) return;

        let size = BASE_SIZE;
        let safety = 40;

        while (el.offsetHeight > MAX_HEIGHT && size > MIN_SIZE && safety-- > 0) {
          size -= 2;
          el.style.fontSize = size + "px";
        }
      }

      const labelBindings = [
        { inputId: "labelClassInput", targetId: "labelCoffeeClass" },
        { inputId: "labelRegionInput", targetId: "labelCoffeeRegion" },
        { inputId: "labelDescriptorsInput", targetId: "labelCoffeeDescriptors" },
        { inputId: "labelMethodInput", targetId: "labelCoffeeMethod" },
      ];

      // Main label live update
      labelBindings.forEach(({ inputId, targetId }) => {
        const inputEl = document.getElementById(inputId);
        const targetEl = document.getElementById(targetId);
        if (!inputEl || !targetEl) return;

        const sync = () => {
          targetEl.textContent = inputEl.value;
          if (targetId === "labelCoffeeRegion") fitRegionText();
        };

        inputEl.addEventListener("input", sync);
        sync();
      });

      generateBarcode(document.getElementById("codeInput").value.trim());
      fitRegionText();

      const toggleCheckbox = document.getElementById("toggleLabelBarcode");
      const barcodeContainer = document.querySelector("#coffeeLabel .barcode");

      if (toggleCheckbox && barcodeContainer) {
        const applyBarcodeVisibility = () => {
          barcodeContainer.style.display = toggleCheckbox.checked ? "block" : "none";
        };
        toggleCheckbox.addEventListener("change", applyBarcodeVisibility);
        applyBarcodeVisibility();
      }

      document.getElementById("downloadLabelPdfBtn").addEventListener("click", openPrintLabelWindow);

      // ---------- MOCKUP LOGIC ----------

      (function initMockup() {
        const stage = document.getElementById("mockupStage");
        const transparentChk = document.getElementById("mockupTransparent");

        const imgInput = document.getElementById("mockupImage");
        const imgEl = document.getElementById("mockupImgEl");
        const clearImgBtn = document.getElementById("mockupClearImage");

        const refreshLabelBtn = document.getElementById("mockupRefreshLabel");
        const labelSource = document.getElementById("coffeeLabel");
        const labelHolder = document.getElementById("mockupLabelHolder");

        const bg1 = document.getElementById("bg1");
        const bg2 = document.getElementById("bg2");
        const bg3 = document.getElementById("bg3");
        const bg4 = document.getElementById("bg4");
        const bgCustom = document.getElementById("mockupBgCustom");
        const downloadImgBtn = document.getElementById("mockupDownloadImg");

        if (!stage || !labelSource || !labelHolder || !imgEl) return;

        // Default mockup image (keep it here so it can use imgEl safely)
        const DEFAULT_MOCKUP_IMAGE = "./spiritus1kg-promo.png"; // change path if needed

        function preloadDefaultMockupImage() {
          const pre = new Image();
          pre.onload = () => {
            imgEl.src = DEFAULT_MOCKUP_IMAGE;
            imgEl.style.display = "block";
          };
          pre.onerror = () => {
            console.warn("Failed to preload mockup image:", DEFAULT_MOCKUP_IMAGE);
          };
          pre.src = DEFAULT_MOCKUP_IMAGE;
        }

        const BG_PRESETS = ["#d593f6", "#9cfa3d", "#ffffff", "#000000"];

        function setActiveSwatch(activeEl) {
          [bg1, bg2, bg3, bg4].forEach((el) => el && el.classList.remove("is-active"));
          if (activeEl) activeEl.classList.add("is-active");
        }

        function applyTransparent() {
          if (transparentChk.checked) {
            stage.classList.add("is-transparent");
            stage.style.backgroundColor = "transparent";
            setActiveSwatch(null);
            return true;
          }
          stage.classList.remove("is-transparent");
          stage.style.backgroundImage = "none";
          return false;
        }

        function setBgColor(color, activeEl = null) {
          transparentChk.checked = false;
          stage.classList.remove("is-transparent");
          stage.style.backgroundImage = "none";
          stage.style.backgroundColor = color;
          if (bgCustom) bgCustom.value = color;
          setActiveSwatch(activeEl);
        }

        function paintSwatches() {
          const els = [bg1, bg2, bg3, bg4];
          els.forEach((el, i) => {
            if (!el) return;
            el.style.background = BG_PRESETS[i];
          });
        }

        // IMPORTANT: no extra auto-scale here; the holder does the transform.
        function mountLabelClone() {
          labelHolder.innerHTML = "";
          const clone = labelSource.cloneNode(true);
          clone.id = "coffeeLabelClone";

          // keep the clone at its real size; the holder transform handles sizing
          clone.style.width = "570px";
          clone.style.height = "710px";
          clone.style.margin = "0";
          clone.style.transform = "none";
          clone.style.transformOrigin = "center";

          labelHolder.appendChild(clone);
        }

        // Real-time refresh (throttled)
        let cloneRaf = 0;
        function scheduleCloneRefresh() {
          cancelAnimationFrame(cloneRaf);
          cloneRaf = requestAnimationFrame(() => {
            mountLabelClone();
          });
        }

        function onImageFile(file) {
          if (!file) return;
          const url = URL.createObjectURL(file);
          imgEl.src = url;
          imgEl.style.display = "block";
        }

        async function downloadMockupPng() {
          const rect = stage.getBoundingClientRect();
          const capWidth = Math.round(rect.width);
          const capHeight = Math.round(rect.height);

          const isTrans = !!transparentChk?.checked;
          const backgroundColor = isTrans ? null : stage.style.backgroundColor || "#ffffff";

          const capScale = Math.min(3, Math.max(2, window.devicePixelRatio || 2));

          const canvas = await html2canvas(stage, {
            width: capWidth,
            height: capHeight,
            scale: capScale,
            useCORS: true,
            backgroundColor,
            scrollX: -window.scrollX,
            scrollY: -window.scrollY,
          });

          const url = canvas.toDataURL("image/png");
          const a = document.createElement("a");
          a.href = url;
          a.download = "mockup.png";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }

        // Events
        transparentChk.addEventListener("change", () => {
          applyTransparent();
          scheduleCloneRefresh();
        });

        bg1 && bg1.addEventListener("click", () => (setBgColor(BG_PRESETS[0], bg1), scheduleCloneRefresh()));
        bg2 && bg2.addEventListener("click", () => (setBgColor(BG_PRESETS[1], bg2), scheduleCloneRefresh()));
        bg3 && bg3.addEventListener("click", () => (setBgColor(BG_PRESETS[2], bg3), scheduleCloneRefresh()));
        bg4 && bg4.addEventListener("click", () => (setBgColor(BG_PRESETS[3], bg4), scheduleCloneRefresh()));

        bgCustom &&
          bgCustom.addEventListener("input", () => {
            setBgColor(bgCustom.value, null);
            scheduleCloneRefresh();
          });

        imgInput &&
          imgInput.addEventListener("change", (e) => {
            const file = e.target.files && e.target.files[0];
            if (file) onImageFile(file);
          });

        clearImgBtn.addEventListener("click", () => {
          imgEl.src = "";
          imgEl.style.display = "none";
          imgInput.value = "";
        });

        refreshLabelBtn.addEventListener("click", () => {
          mountLabelClone();
        });

        downloadImgBtn.addEventListener("click", downloadMockupPng);

        // Hook main label inputs + barcode toggle + generate -> refresh clone live
        ["labelClassInput", "labelRegionInput", "labelDescriptorsInput", "labelMethodInput"].forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener("input", scheduleCloneRefresh);
        });

        const toggleBarcode = document.getElementById("toggleLabelBarcode");
        if (toggleBarcode) toggleBarcode.addEventListener("change", scheduleCloneRefresh);

        const generateBtn = document.getElementById("generateBtn");
        if (generateBtn) generateBtn.addEventListener("click", scheduleCloneRefresh);

        // Init
        paintSwatches();
        setBgColor(BG_PRESETS[2], bg3); // default: white
        mountLabelClone();
        preloadDefaultMockupImage();
      })();
    </script>
  </body>
</html>
